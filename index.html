<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8">
  <title>XifraRecerca</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
  <style>
    :root {
      --main-bg: #f6f8fa;
      --main-text: #1b3355;
      --container-bg: #fff;
      --container-shadow: 0 8px 32px rgba(34,68,136,0.12);
      --result-bg: #f3f7fd;
      --alert-bg: #fde5e5;
      --alert-text: #a00;
      --button-bg: #224488;
      --button-hover: #163466;
      --download-bg: #338822;
      --download-hover: #266a16;
      --border: #dae4f2;
      --input-bg: #fff;
      --input-text: #222;
      --radius-xl: 18px;
      --radius-lg: 12px;
      --radius-md: 8px;
      --radius-sm: 6px;
      --blue-accent: #1b3355;
      --blue-faded: #eaf1fa;
      --gap-xl: 36px;
      --gap-lg: 24px;
      --gap-md: 16px;
      --gap-sm: 10px;
      --anim-bg: linear-gradient(90deg,#eaf1fa 0%,#f6f8fa 100%);
    }
    [data-theme="dark"] {
      --main-bg: #181c24;
      --main-text: #e3eaff;
      --container-bg: #232742;
      --container-shadow: 0 8px 32px rgba(34,68,136,0.22);
      --result-bg: #232742;
      --alert-bg: #3b1b1b;
      --alert-text: #ff9494;
      --button-bg: #375a8c;
      --button-hover: #1a3566;
      --download-bg: #338822;
      --download-hover: #266a16;
      --border: #444e64;
      --input-bg: #232742;
      --input-text: #fff;
      --blue-accent: #a3cdfd;
      --blue-faded: #232742;
      --anim-bg: linear-gradient(90deg,#232742 0%,#181c24 100%);
    }
    body { font-family: 'Inter', 'Segoe UI', Arial, sans-serif; background: var(--main-bg); margin: 0; padding: 0; color: var(--main-text); min-height: 100vh; }
    .container {
      max-width: 540px;
      margin: var(--gap-xl) auto var(--gap-lg) auto;
      background: var(--container-bg);
      border-radius: var(--radius-xl);
      box-shadow: var(--container-shadow);
      padding: var(--gap-lg) var(--gap-md) var(--gap-lg) var(--gap-md);
      display: flex; flex-direction: column; gap: var(--gap-md);
      position: relative;
      animation: fadeinbg 1.2s cubic-bezier(.51,.91,.36,1.18);
      background-image: var(--anim-bg);
    }
    @keyframes fadeinbg {
      0% { opacity: 0; transform: scale(.97);}
      60% { opacity: .8; }
      100% { opacity: 1; transform: scale(1);}
    }
    h1 { text-align: center; color: var(--blue-accent); margin-top: 0; margin-bottom: var(--gap-md);}
    h2 { color: var(--blue-accent); margin-top: 0; margin-bottom: var(--gap-sm);}
    .mode-lang-bar {
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: var(--gap-md);
      gap: 22px;
      animation: fadeinbar .8s cubic-bezier(.42,.85,.31,.99);
    }
    @keyframes fadeinbar {
      from { opacity: 0; transform: translateY(-12px);}
      to { opacity: 1; transform: translateY(0);}
    }
    button, input, textarea, select { font-size: 1.08rem; margin-top: var(--gap-sm); }
    button {
      background: var(--button-bg);
      color: #fff;
      border: none;
      border-radius: var(--radius-lg);
      padding: 14px 0; width: 100%;
      cursor: pointer;
      transition: background .22s, box-shadow .22s, transform .22s;
      font-weight: 500;
      letter-spacing: 0.05em;
      box-shadow: 0 2px 8px rgba(34,68,136,0.06);
      margin-bottom: 0;
      outline: none;
    }
    button:active { transform: scale(0.96);}
    button:hover { background: var(--button-hover); box-shadow: 0 4px 20px rgba(34,68,136,0.18);}
    .row { display: flex; gap: var(--gap-sm); margin-bottom: var(--gap-md);}
    .row > * { flex: 1; }
    label { font-weight: 500; margin-bottom: 4px; display: inline-block;}
    textarea, input[type="number"], input[type="text"], select {
      width: 100%;
      padding: 10px;
      border: 1.5px solid var(--border);
      border-radius: var(--radius-md);
      resize: vertical;
      min-height: 40px;
      background: var(--input-bg);
      color: var(--input-text);
      box-sizing: border-box;
      margin-bottom: 0;
      transition: border .18s;
      font-family: inherit;
      font-size: 1em;
    }
    textarea:focus, input:focus, select:focus { border-color: #3377ff; }
    select { min-width: 120px; }
    .result {
      background: var(--result-bg);
      border-radius: var(--radius-lg);
      padding: var(--gap-md);
      margin-top: var(--gap-md);
      font-size: 1.06em;
      color: inherit;
      word-break: break-word;
      box-shadow: 0 2px 8px rgba(34,68,136,0.08);
      animation: fadeinresult .65s cubic-bezier(.51,.91,.36,1.18);
    }
    @keyframes fadeinresult {
      from { opacity: 0; transform: translateY(10px);}
      to { opacity: 1; transform: translateY(0);}
    }
    .back {
      margin-top: var(--gap-md);
      display: block;
      text-align: center;
      color: var(--blue-accent);
      cursor: pointer;
      text-decoration: underline;
      transition: color 0.2s;
      font-size: 1.03em;
      outline: none;
      border-radius: var(--radius-md);
      padding: 5px 0;
    }
    .back:hover, .back:focus { color: #3377ff; background: var(--blue-faded);}
    .download-btn { background: var(--download-bg);}
    .download-btn:hover { background: var(--download-hover);}
    .small { font-size: 0.96em; color: #555; }
    .alert { background: var(--alert-bg); color: var(--alert-text); padding: 10px; border-radius: var(--radius-md); margin-bottom: var(--gap-sm); font-size: 1em; animation: fadeinalert .7s cubic-bezier(.51,.91,.36,1.18);}
    @keyframes fadeinalert {
      from { opacity: 0; transform: scale(.98);}
      to { opacity: 1; transform: scale(1);}
    }
    .footer {
      text-align: center;
      font-size: 0.98em;
      color: #aaa;
      margin: var(--gap-xl) 0 0 0;
      padding-bottom: var(--gap-sm);
      animation: fadeinfooter .8s cubic-bezier(.42,.85,.31,.99);
    }
    @keyframes fadeinfooter {
      from { opacity: 0; transform: translateY(16px);}
      to { opacity: 1; transform: translateY(0);}
    }
    #spinner { display:none; text-align:center; margin:var(--gap-md) 0;}
    .mode-toggle { display: flex; gap: 6px;}
    .mode-toggle button { padding: 6px 18px; font-size: 1.00em; background: var(--blue-faded); color: var(--blue-accent); border-radius:20px; border:none;}
    .mode-toggle button.active { background: var(--blue-accent); color: #fff;}
    .lang-selector select { padding:8px 14px; border-radius:10px; font-size:1.03em; border:1.5px solid var(--border);}
    .warning-primes {
      background: #fde5e5;
      color: #a00;
      border-radius: var(--radius-lg);
      padding: 12px;
      margin-top: var(--gap-md);
      font-size: 1em;
      box-shadow: 0 2px 8px rgba(34,68,136,0.04);
      animation: fadeinalert .7s cubic-bezier(.51,.91,.36,1.18);
    }
    [data-theme="dark"] .warning-primes { background: #3b1b1b; color: #ff9494; }
    .container, .result, .warning-primes {
      transition: background 0.18s, color 0.18s, box-shadow 0.18s;
    }
    .result b, .result span.small, .warning-primes { font-weight: 500;}
    .result b { color: var(--blue-accent);}
    @media (max-width: 700px) {
      .container { max-width: 99vw; padding: var(--gap-md) 3vw var(--gap-md) 3vw;}
      h1, h2 { font-size: 1.45em; }
    }
    @media (max-width: 450px) {
      .container { padding: 3vw 2vw;}
      .result { padding: 10px; }
      h1, h2 { font-size: 1.1em; }
      .mode-lang-bar { gap: 12px;}
      .mode-toggle button, .lang-selector select { font-size: 0.94em;}
    }
  </style>
</head>
<body data-theme="light">
  <div class="container" role="main" aria-label="Aplicaci√≥ RSA">
    <div class="mode-lang-bar">
      <div class="lang-selector" aria-label="Selector d'idioma">
        <select id="lang-select" aria-label="Canvia l'idioma">
          <option value="ca">Catal√†</option>
          <option value="es">Castell√†</option>
          <option value="en">English</option>
          <option value="fr">Fran√ßais</option>
        </select>
      </div>
      <div class="mode-toggle" aria-label="Canvi de tema">
        <button id="toggle-dark">üåô</button>
        <button id="toggle-light" class="active">‚òÄÔ∏è</button>
      </div>
    </div>
    <div id="pantalla-inici">
      <h1>XifraRecerca</h1>
      <p id="welcome-msg"></p>
      <div style="margin-top:36px; display:flex; flex-direction:column; gap:var(--gap-md);">
        <button onclick="mostrarPantalla('xifrar')" aria-label="" id="btn-xifrar"></button>
        <button onclick="mostrarPantalla('desxifrar')" aria-label="" id="btn-desxifrar"></button>
      </div>
    </div>
    <div id="pantalla-xifrar" style="display:none;" aria-label="">
      <h2 id="title-xifrar"></h2>
      <form id="form-xifrar" autocomplete="off" aria-label="" role="form">
        <label for="input-text" id="label-text"></label>
        <textarea id="input-text" rows="3" required aria-required="true"></textarea>
        <div class="row">
          <div>
            <label for="input-p" id="label-p"></label>
            <input type="number" id="input-p" min="2" max="999999999999999999" step="1" required aria-required="true" aria-label="" aria-describedby="p-help">
            <span id="p-help" class="small"></span>
          </div>
          <div>
            <label for="input-q" id="label-q"></label>
            <input type="number" id="input-q" min="2" max="999999999999999999" step="1" required aria-required="true" aria-label="" aria-describedby="q-help">
            <span id="q-help" class="small"></span>
          </div>
        </div>
        <!-- AVAN√áADES ELIMINADES -->
        <div id="claus-bits" class="small" aria-live="polite" style="display:none;"></div>
        <div id="claus-bytes" class="small" aria-live="polite" style="display:none;"></div>
        <div id="claus-ms" class="small" aria-live="polite" style="display:none;"></div>
        <button type="submit" aria-label="" id="btn-submit-xifrar"></button>
      </form>
      <div id="alert-xifrar" class="alert" style="display:none;" role="alert"></div>
      <div id="spinner"><img src="https://cdn.jsdelivr.net/gh/marcsse/xifrarecerca/spinner.svg" alt="Carregant..." width="32"><br><span id="load-msg"></span></div>
      <div id="result-xifrar" class="result" style="display:none;" aria-live="polite"></div>
      <button id="copy-result" style="display:none;"></button>
      <button id="download-xifrar" class="download-btn" style="display:none;"></button>
      <div class="warning-primes" id="small-primes-warning" style="display:none;"></div>
      <div class="back" onclick="mostrarPantalla('inici')" tabindex="0" id="back-xifrar">‚Üê Torna a l'inici</div>
    </div>
    <div id="pantalla-desxifrar" style="display:none;" aria-label="">
      <h2 id="title-desxifrar"></h2>
      <form id="form-desxifrar" autocomplete="off" aria-label="" role="form">
        <label for="input-xifrat" id="label-xifrat"></label>
        <textarea id="input-xifrat" rows="3" required aria-required="true"></textarea>
        <div class="row">
          <div>
            <label for="input-d" id="label-d"></label>
            <input type="number" id="input-d" min="1" step="1" required aria-required="true">
          </div>
          <div>
            <label for="input-n" id="label-n"></label>
            <input type="number" id="input-n" min="2" step="1" required aria-required="true">
          </div>
        </div>
        <button type="submit" aria-label="" id="btn-submit-desxifrar"></button>
      </form>
      <div id="result-desxifrar" class="result" style="display:none;" aria-live="polite"></div>
      <button id="copy-desxifrat" style="display:none;"></button>
      <button id="download-desxifrat" class="download-btn" style="display:none;"></button>
      <div class="small" id="claus-ms-desxifrar" style="display:none;"></div>
      <div class="back" onclick="mostrarPantalla('inici')" tabindex="0" id="back-desxifrar">‚Üê Torna a l'inici</div>
    </div>
  </div>
  <div class="footer" aria-label="Peu de p√†gina">
    &copy; 2025 XifraRecerca ¬∑ Fet per Marc San Jos√©
  </div>
  <script>
    // ===== MULTILANGUAGE TEXTS =====
    const texts = {
      ca: {
        welcome: 'Benvingut a XifraRecerca, el teu xifrador i desxifrador de confian√ßa,<br>desenvolupat per Marc San Jos√© Casals com a part del treball de recerca de batxillerat.<br>Per qualsevol dubte o sugger√®ncia, no dubtis a contactar-me a msanjosecasals@inspineda.com, Si no saps quins nombres primers utilitzar, aquests dos s√≥n els que et recomano: s√≥n els m√©s segurs i compatibles amb l‚Äôapp.p = 1000000000000399, q =1000000000000037',
        xifrar: 'Xifrar un missatge',
        desxifrar: 'Desxifrar un missatge',
        copy: 'Copia al porta-retalls',
        copied: 'Copiat al porta-retalls!',
        downloading: 'Descarrega resultat (.txt)',
        bits: n => `Mida de n: <b>${n.toString(2).length}</b> bits`,
        bytes: b => `Pes en bytes del missatge xifrat: <b>${b}</b> bytes`,
        ms: ms => `Temps de xifrat/desxifrat: <b>${ms}</b> ms`,
        loading: 'Carregant Python...',
        invalidPrime: 'Almenys un dels nombres NO √©s primer.',
        samePrime: 'p i q han de ser <b>nombres primers diferents</b>!',
        tooBig: 'Els nombres s√≥n massa grans (m√†xim: 999.999.999.999.999.999).',
        notPrime: name => `El nombre <b>${name}</b> no √©s primer.`,
        notSupportedChar: 'El text cont√© car√†cters no suportats (emojis o s√≠mbols especials).',
        selectLang: 'Canvia l\'idioma',
        advanced: 'Opcions avan√ßades',
        labelE: 'Valor de la clau p√∫blica e:',
        toggleBits: 'Mostra la mida de la clau',
        toggleBytes: 'Mostra el pes en bytes del missatge xifrat',
        smallPrimesWarning: '‚ö†Ô∏è ATENCI√ì: Bones, mag de la criptografia! Has triat nombres massa petits per xifrar... (Ideal per a demostracions, per√≤ ni s‚Äôaconsella enviar secrets de veritat aix√≠!) Si no vols que t‚Äôenxampin, et recomano que utilitzis nombres primers d‚Äôalmenys sis xifres, com per exemple p = 104729 i q =1000039.',
        thanks: 'Gr√†cies per desxifrar amb XifraRecerca! Torna a l\'inici per xifrar o desxifrar un altre missatge.',
        originalText: 'Text original:',
        primeP: 'Nombre primer p (‚â•2):',
        primeQ: 'Nombre primer q (‚â•2):',
        encryptTitle: 'üîê Xifrar un missatge',
        decryptTitle: 'üîì Desxifrar un missatge',
        encryptedInput: 'Missatge xifrat (llista de nombres separats per comes):',
        privateD: 'Clau privada d:',
        privateN: 'Clau privada n:',
        encrypt: 'Xifrar',
        decrypt: 'Desxifrar',
        downloadDecrypted: 'Descarrega desxifrat (.txt)',
        backToStart: "‚Üê Torna a l'inici",
      },
      es: {
        welcome: 'Bienvenido a XifraRecerca, tu cifrador y descifrador de confianza,<br>desarrollado por Marc San Jos√© Casals como parte del trabajo de investigaci√≥n de bachillerato.<br>Para cualquier duda o sugerencia, cont√°ctame en msanjosecasals@inspineda.com, Si no sabes qu√© n√∫meros primos deber√≠as usar, estos dos son los que te recomiendo; son los n√∫meros primos m√°s seguros compatibles con la app: p = 1000000000000399, q = 1000000000000037.',
        xifrar: 'Cifrar un mensaje',
        desxifrar: 'Descifrar un mensaje',
        copy: 'Copiar al portapapeles',
        copied: '¬°Copiado al portapapeles!',
        downloading: 'Descarga resultado (.txt)',
        bits: n => `Tama√±o de n: <b>${n.toString(2).length}</b> bits`,
        bytes: b => `Peso en bytes del mensaje cifrado: <b>${b}</b> bytes`,
        ms: ms => `Tiempo de cifrado/descifrado: <b>${ms}</b> ms`,
        loading: 'Cargando Python...',
        invalidPrime: '¬°Alguno de los n√∫meros NO es primo!',
        samePrime: '¬°p y q deben ser <b>primos distintos</b>!',
        tooBig: 'Los n√∫meros son demasiado grandes (m√°ximo: 999.999.999.999.999.999).',
        notPrime: name => `El n√∫mero <b>${name}</b> no es primo.`,
        notSupportedChar: 'El texto contiene caracteres no soportados (emojis o s√≠mbolos especiales).',
        selectLang: 'Cambia idioma',
        advanced: 'Opciones avanzadas',
        labelE: 'Valor de la clave p√∫blica e:',
        toggleBits: 'Mostrar tama√±o de la clave',
        toggleBytes: 'Mostrar peso en bytes del mensaje cifrado',
        smallPrimesWarning: '‚ö†Ô∏è ¬°Atenci√≥n, mago de la criptograf√≠a! Has elegido n√∫meros demasiado peque√±os para cifrar... (Ideal para demostraciones, pero no se recomienda enviar secretos reales as√≠). Si no quieres que te pillen, te recomiendo usar n√∫meros primos de al menos seis cifras, como p = 104729 y q = 1000039.',
        thanks: '¬°Gracias por descifrar con XifraRecerca! Vuelve al inicio para cifrar o descifrar otro mensaje.',
        originalText: 'Texto original:',
        primeP: 'N√∫mero primo p (‚â•2):',
        primeQ: 'N√∫mero primo q (‚â•2):',
        encryptTitle: 'üîê Cifrar un mensaje',
        decryptTitle: 'üîì Descifrar un mensaje',
        encryptedInput: 'Mensaje cifrado (lista de n√∫meros separados por comas):',
        privateD: 'Clave privada d:',
        privateN: 'Clave privada n:',
        encrypt: 'Cifrar',
        decrypt: 'Descifrar',
        downloadDecrypted: 'Descarga descifrado (.txt)',
        backToStart: "‚Üê Volver al inicio",
      },
      en: {
        welcome: 'Welcome to XifraRecerca, your trusted encryptor and decryptor,<br>developed by Marc San Jos√© Casals as part of his high school research project.<br>For any questions or suggestions, contact me at msanjosecasals@inspineda.com, If you don‚Äôt know which prime numbers you should use, these two are the ones I recommend; they are the safest prime numbers compatible with the app: p = 1000000000000399, q = 1000000000000037.',
        xifrar: 'Encrypt a message',
        desxifrar: 'Decrypt a message',
        copy: 'Copy to clipboard',
        copied: 'Copied to clipboard!',
        downloading: 'Download result (.txt)',
        bits: n => `Key size n: <b>${n.toString(2).length}</b> bits`,
        bytes: b => `Encrypted message size: <b>${b}</b> bytes`,
        ms: ms => `Encryption/decryption time: <b>${ms}</b> ms`,
        loading: 'Loading Python...',
        invalidPrime: 'At least one number is NOT prime.',
        samePrime: 'p and q must be <b>different prime numbers</b>!',
        tooBig: 'Numbers are too large (max: 999.999.999.999.999.999).',
        notPrime: name => `The number <b>${name}</b> is not prime.`,
        notSupportedChar: 'Text contains unsupported characters (emojis or special symbols).',
        selectLang: 'Change language',
        advanced: 'Advanced options',
        labelE: 'Value of public key e:',
        toggleBits: 'Show key size',
        toggleBytes: 'Show encrypted message size in bytes',
        smallPrimesWarning: '‚ö†Ô∏è ATTENTION: Crypto wizard! You\'ve chosen numbers that are too small for encryption... (Good for demos, but not recommended for real secrets!) If you don\'t want to get caught, use primes with at least six digits, like p = 104729 and q = 1000039.',
        thanks: 'Thanks for decrypting with XifraRecerca! Go back to start to encrypt or decrypt another message.',
        originalText: 'Original text:',
        primeP: 'Prime number p (‚â•2):',
        primeQ: 'Prime number q (‚â•2):',
        encryptTitle: 'üîê Encrypt a message',
        decryptTitle: 'üîì Decrypt a message',
        encryptedInput: 'Encrypted message (comma-separated list of numbers):',
        privateD: 'Private key d:',
        privateN: 'Private key n:',
        encrypt: 'Encrypt',
        decrypt: 'Decrypt',
        downloadDecrypted: 'Download decrypted (.txt)',
        backToStart: "‚Üê Back to start",
      },
      fr: {
        welcome: 'Bienvenue sur XifraRecerca, ton outil de chiffrement/d√©chiffrement de confiance,<br>d√©velopp√© par Marc San Jos√© Casals dans le cadre d\'un travail de recherche au lyc√©e.<br>Pour toute question ou suggestion, contacte-moi √† msanjosecasals@inspineda.com, Si vous ne savez pas quels nombres premiers utiliser, ceux-ci sont ceux que je recommande ; ce sont les nombres premiers les plus s√ªrs compatibles avec l‚Äôapplication : p = 1000000000000399, q = 1000000000000037.',
        xifrar: 'Chiffrer un message',
        desxifrar: 'D√©chiffrer un message',
        copy: 'Copier dans le presse-papiers',
        copied: 'Copi√© dans le presse-papiers !',
        downloading: 'T√©l√©charger le r√©sultat (.txt)',
        bits: n => `Taille de n : <b>${n.toString(2).length}</b> bits`,
        bytes: b => `Poids en octets du message chiffr√© : <b>${b}</b> octets`,
        ms: ms => `Temps de chiffrement/d√©chiffrement : <b>${ms}</b> ms`,
        loading: 'Chargement de Python...',
        invalidPrime: 'Au moins un des nombres N\'EST PAS premier.',
        samePrime: 'p et q doivent √™tre <b>des nombres premiers diff√©rents</b> !',
        tooBig: 'Les nombres sont trop grands (max : 999.999.999.999.999.999).',
        notPrime: name => `Le nombre <b>${name}</b> n\'est pas premier.`,
        notSupportedChar: 'Le texte contient des caract√®res non pris en charge (emojis ou symboles sp√©ciaux).',
        selectLang: 'Changer de langue',
        advanced: 'Options avanc√©es',
        labelE: 'Valeur de la cl√© publique e :',
        toggleBits: 'Afficher la taille de la cl√©',
        toggleBytes: 'Afficher le poids en octets du message chiffr√©',
        smallPrimesWarning: '‚ö†Ô∏è ATTENTION : Magicien de la crypto ! Tu as choisi des nombres trop petits pour le chiffrement... (Bien pour les d√©mos, mais pas pour des secrets r√©els !) Pour ne pas te faire pi√©ger, utilise des premiers d\'au moins six chiffres, comme p = 104729 et q = 1000039.',
        thanks: 'Merci pour le d√©chiffrement avec XifraRecerca ! Retour √† l\'accueil pour chiffrer ou d√©chiffrer un autre message.',
        originalText: 'Texte original :',
        primeP: 'Nombre premier p (‚â•2) :',
        primeQ: 'Nombre premier q (‚â•2) :',
        encryptTitle: 'üîê Chiffrer un message',
        decryptTitle: 'üîì D√©chiffrer un message',
        encryptedInput: 'Message chiffr√© (liste de nombres s√©par√©s par des virgules) :',
        privateD: 'Cl√© priv√©e d :',
        privateN: 'Cl√© priv√©e n :',
        encrypt: 'Chiffrer',
        decrypt: 'D√©chiffrer',
        downloadDecrypted: 'T√©l√©charger d√©chiffr√© (.txt)',
        backToStart: "‚Üê Retour √† l'accueil",
      }
    };

    let currentLang = 'ca';

    function setLang(lang) {
      currentLang = lang;
      const t = texts[lang];

      // Inici
      document.getElementById('welcome-msg').innerHTML = t.welcome;
      document.getElementById('btn-xifrar').innerText = t.xifrar;
      document.getElementById('btn-xifrar').setAttribute('aria-label', t.xifrar);
      document.getElementById('btn-desxifrar').innerText = t.desxifrar;
      document.getElementById('btn-desxifrar').setAttribute('aria-label', t.desxifrar);

      // Xifrar
      document.getElementById('title-xifrar').innerText = t.encryptTitle;
      document.getElementById('label-text').innerText = t.originalText;
      document.getElementById('label-p').innerText = t.primeP;
      document.getElementById('label-q').innerText = t.primeQ;
      document.getElementById('btn-submit-xifrar').innerText = t.encrypt;
      document.getElementById('btn-submit-xifrar').setAttribute('aria-label', t.encrypt);
      document.getElementById('copy-result').innerText = t.copy;
      document.getElementById('download-xifrar').innerText = t.downloading;
      document.getElementById('back-xifrar').innerText = t.backToStart;

      // Desxifrar
      document.getElementById('title-desxifrar').innerText = t.decryptTitle;
      document.getElementById('label-xifrat').innerText = t.encryptedInput;
      document.getElementById('label-d').innerText = t.privateD;
      document.getElementById('label-n').innerText = t.privateN;
      document.getElementById('btn-submit-desxifrar').innerText = t.decrypt;
      document.getElementById('btn-submit-desxifrar').setAttribute('aria-label', t.decrypt);
      document.getElementById('copy-desxifrat').innerText = t.copy;
      document.getElementById('download-desxifrat').innerText = t.downloadDecrypted;
      document.getElementById('back-desxifrar').innerText = t.backToStart;

      // Optionally update aria-labels if you want live accessibility
      document.getElementById('pantalla-xifrar').setAttribute('aria-label', t.encryptTitle);
      document.getElementById('pantalla-desxifrar').setAttribute('aria-label', t.decryptTitle);
      document.getElementById('pantalla-inici').setAttribute('aria-label', t.welcome.replace(/<br>/g, ' '));
    }

    // ===== THEME TOGGLE =====
    function setTheme(theme) {
      document.body.setAttribute('data-theme', theme);
      document.getElementById('toggle-dark').classList.toggle('active', theme === "dark");
      document.getElementById('toggle-light').classList.toggle('active', theme === "light");
    }
    document.getElementById('toggle-dark').onclick = () => setTheme('dark');
    document.getElementById('toggle-light').onclick = () => setTheme('light');

    // ===== LANGUAGE SELECTOR =====
    document.getElementById('lang-select').onchange = function() {
      setLang(this.value);
      validatePrimes();
    };

    // ====== INITIALIZE UI ======
    setLang('ca');
    setTheme('light');

    // ========== Pyodide & Python code (NO TOCAR) ==============
    let pyodideReady = false;
    let pyodide = null;
    const pythonCode = `
def mcd(a, b):
    while b:
        a, b = b, a % b
    return a
def invers_mod(a, m):
    t, nova_t = 0, 1
    r, nova_r = m, a
    while nova_r != 0:
        q = r // nova_r
        t, nova_t = nova_t, t - q * nova_t
        r, nova_r = nova_r, r - q * nova_r
    if r > 1:
        return None
    if t < 0:
        t += m
    return t
def es_primer(n):
    if n < 2:
        return False
    if n == 2:
        return True
    if n % 2 == 0:
        return False
    for i in range(3, int(n ** 0.5) + 1, 2):
        if n % i == 0:
            return False
    return True
def generar_claus_segures(p, q, e=65537):
    if not es_primer(p) or not es_primer(q):
        raise Exception("Almenys un dels nombres NO √©s primer.")
    if p == q:
        raise Exception("p i q han de ser diferents.")
    n = p * q
    phi = (p - 1) * (q - 1)
    if mcd(e, phi) != 1:
        e = 3
        while mcd(e, phi) != 1:
            e += 2
    d = invers_mod(e, phi)
    if d is None:
        raise Exception("No s'ha pogut calcular la clau privada amb aquests nombres. Prova amb altres nombres primers.")
    return (e, n), (d, n)
def text_a_blocs(text, mida_bloc):
    blocs = []
    for i in range(0, len(text), mida_bloc):
        bloc = text[i:i + mida_bloc]
        num = 0
        for c in bloc:
            num = num * 256 + ord(c)
        blocs.append(num)
    return blocs
def xifrar_blocs(blocs, clau_pub):
    e, n = clau_pub
    return [pow(b, e, n) for b in blocs]
def xifrar_paragrafs(text, mida_bloc, clau_pub):
    paragrafs = text.split('\\n')
    xifrat_paragrafs = []
    for par in paragrafs:
        blocs = text_a_blocs(par, mida_bloc)
        xifrat = xifrar_blocs(blocs, clau_pub)
        xifrat_paragrafs.append(xifrat)
    return xifrat_paragrafs
def blocs_a_text(blocs, mida_bloc):
    text = ""
    for num in blocs:
        chars = []
        for _ in range(mida_bloc):
            chars.append(chr(num % 256))
            num //= 256
        chars.reverse()
        text += "".join(chars)
    return text
def desxifrar_blocs(blocs_xifrats, clau_priv):
    d, n = clau_priv
    return [pow(b, d, n) for b in blocs_xifrats]
def desxifrar_text(xifrat_blocs, clau_priv):
    d, n = clau_priv
    mida_bloc = 1
    while (256 ** (mida_bloc + 1)) < n:
        mida_bloc += 1
    blocs = desxifrar_blocs(xifrat_blocs, clau_priv)
    text = blocs_a_text(blocs, mida_bloc)
    text = text.lstrip('\\x00')
    return text
`;

    async function carregarPyodide() {
      document.getElementById('spinner').style.display = '';
      document.getElementById('load-msg').textContent = texts[currentLang].loading;
      pyodide = await loadPyodide({ indexURL: "https://cdn.jsdelivr.net/pyodide/v0.24.1/full/" });
      pyodide.runPython(pythonCode);
      pyodideReady = true;
      document.getElementById('spinner').style.display = 'none';
    }
    carregarPyodide();

    function esPrimer(n) {
      if (n<2) return false;
      if (n===2) return true;
      if (n%2===0) return false;
      let sqrt = Math.floor(Math.sqrt(n));
      for(let i=3;i<=sqrt;i+=2) if (n%i===0) return false;
      return true;
    }
    function textValid(text) {
      return /^[\p{L}\p{N}\p{P}\p{S}\p{M}\p{Zs}\s]+$/u.test(text);
    }

    // ========== XIFRAR ==============
    document.getElementById('form-xifrar').onsubmit = async function(e) {
      e.preventDefault();
      document.getElementById('small-primes-warning').style.display = 'none';
      if (!pyodideReady) { alert(texts[currentLang].loading); return; }
      let text = document.getElementById('input-text').value;
      let p = parseInt(document.getElementById('input-p').value, 10);
      let q = parseInt(document.getElementById('input-q').value, 10);
      if (isNaN(p)) p = 104729;
      if (isNaN(q)) q = 1000039;
      if (!textValid(text)) {
        document.getElementById('alert-xifrar').innerHTML = texts[currentLang].notSupportedChar;
        document.getElementById('alert-xifrar').style.display = '';
        return;
      }
      if (!text.trim()) return alert(texts[currentLang].originalText);
      if (!esPrimer(p) || !esPrimer(q)) {
        document.getElementById('alert-xifrar').innerHTML = texts[currentLang].invalidPrime;
        document.getElementById('alert-xifrar').style.display = '';
        return;
      }
      if (p === q) {
        document.getElementById('alert-xifrar').innerHTML = texts[currentLang].samePrime;
        document.getElementById('alert-xifrar').style.display = '';
        return;
      }
      if (p > 999999999999999999 || q > 999999999999999999) {
        document.getElementById('alert-xifrar').innerHTML = texts[currentLang].tooBig;
        document.getElementById('alert-xifrar').style.display = '';
        return;
      }
      document.getElementById('alert-xifrar').style.display = 'none';
      document.getElementById('spinner').style.display = '';
      document.getElementById('load-msg').textContent = texts[currentLang].loading;
      // El valor d'e queda per defecte (65537) i no editable
      let eValue = 65537;
      let showBits = false;
      let showBytes = false;
      let start = performance.now();
      try {
        pyodide.runPython(`
p = ${p}
q = ${q}
e = ${eValue}
clau_pub, clau_priv = generar_claus_segures(p, q, e)
n = clau_pub[1]
mida_bloc = 1
while (256 ** (mida_bloc + 1)) < n:
    mida_bloc += 1
import json
text_usuari = json.loads('${JSON.stringify(text)}')
xifrat = xifrar_paragrafs(text_usuari, mida_bloc, clau_pub)
xifrat_concatenat = []
for par in xifrat:
    xifrat_concatenat.extend(par)
        `);
        let clau_pub = pyodide.globals.get('clau_pub').toJs();
        let clau_priv = pyodide.globals.get('clau_priv').toJs();
        let mida_bloc = pyodide.globals.get('mida_bloc');
        let xifrat_concatenat = pyodide.globals.get('xifrat_concatenat').toJs();
        let n = clau_pub[1];
        let end = performance.now();
        let ms = Math.round(end - start);
        let maxWidth = Math.max(...xifrat_concatenat.map(n => n.toString().length));
        let padded = xifrat_concatenat.map(n => n.toString().padStart(maxWidth, '0'));
        let continuous = `${maxWidth}:${padded.join('')}`;
        let txtToCopy = `Missatge xifrat (string):\n${continuous}\nClau p√∫blica (e, n): (${clau_pub[0]}, ${clau_pub[1]})\nClau privada (d, n): (${clau_priv[0]}, ${clau_priv[1]})`;

        let t = texts[currentLang];
        let res = `<b>Missatge xifrat (string):</b><br>
<span class="small">Amplada de bloc detectada: <b>${maxWidth}</b> d√≠gits (afegida autom√†ticament)</span><br>
<code>${continuous}</code><br>
<br><b>Clau p√∫blica (e, n):</b> (${clau_pub[0]}, ${clau_pub[1]})<br>
<b>Clau privada (d, n):</b> (${clau_priv[0]}, ${clau_priv[1]})<br>
<span class="small">${t.bits(n)}<br>${t.bytes(new TextEncoder().encode(xifrat_concatenat.join(',')).length)}<br>${t.ms(ms)}</span>`;
        document.getElementById('result-xifrar').innerHTML = res;
        document.getElementById('result-xifrar').style.display = '';
        document.getElementById('claus-bits').style.display = showBits ? '' : 'none';
        document.getElementById('claus-bytes').style.display = showBytes ? '' : 'none';
        document.getElementById('claus-ms').style.display = '';
        document.getElementById('claus-bits').innerHTML = showBits ? t.bits(n) : '';
        let bytes = new TextEncoder().encode(xifrat_concatenat.join(',')).length;
        document.getElementById('claus-bytes').innerHTML = showBytes ? t.bytes(bytes) : '';
        document.getElementById('claus-ms').innerHTML = t.ms(ms);
        document.getElementById('download-xifrar').style.display = '';
        document.getElementById('download-xifrar').onclick = function() {
          let txt = `${txtToCopy}\n${showBits ? t.bits(n) : ''}\n${showBytes ? t.bytes(bytes) : ''}\n${t.ms(ms)}`;
          let blob = new Blob([txt], {type: 'text/plain'});
          let a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = 'xifrarecerca_resultat.txt';
          a.click();
        };
        document.getElementById('copy-result').style.display = '';
        document.getElementById('copy-result').onclick = () => {
          navigator.clipboard.writeText(txtToCopy).then(() => {
            alert(t.copied);
          });
        };
        if ((parseInt(document.getElementById('input-p').value,10)<1000)||(parseInt(document.getElementById('input-q').value,10)<1000)) {
          document.getElementById('small-primes-warning').innerHTML = t.smallPrimesWarning;
          document.getElementById('small-primes-warning').style.display = '';
        }
      } catch(err) {
        let msg = err.message || '';
        let t = texts[currentLang];
        if (msg.indexOf('NO √©s primer') !== -1) {
          msg = t.invalidPrime;
        } else if (msg.indexOf('No s\'ha pogut calcular la clau privada') !== -1) {
          msg = t.invalidPrime;
        } else if (msg.indexOf('diferents') !== -1) {
          msg = t.samePrime;
        } else {
          msg = "Error inesperat. Comprova els nombres i el text.";
        }
        document.getElementById('result-xifrar').innerHTML = msg;
        document.getElementById('result-xifrar').style.display = '';
        document.getElementById('download-xifrar').style.display = 'none';
        document.getElementById('copy-result').style.display = 'none';
      }
      document.getElementById('spinner').style.display = 'none';
    };
    // ========== DESXIFRAR ==============
    document.getElementById('form-desxifrar').onsubmit = async function(e) {
      e.preventDefault();
      if (!pyodideReady) { alert(texts[currentLang].loading); return; }
      let xifrat_str = document.getElementById('input-xifrat').value.trim();
      let t = texts[currentLang];
      let match = xifrat_str.match(/^(\d+):(.*)$/);
      if (!match) return alert('El missatge xifrat ha d\'incloure la mida del bloc, ex: 4:00230044...');
      let blocWidth = parseInt(match[1], 10);
      let cifratNums = match[2];
      if (isNaN(blocWidth) || blocWidth <= 0) return alert('Format d\'amplada bloc inv√†lid!');
      if (!/^\d+$/.test(cifratNums)) return alert('El missatge xifrat nom√©s pot contenir d√≠gits despr√©s dels dos punts.');
      if (cifratNums.length % blocWidth !== 0) return alert('El missatge xifrat t√© una longitud incorrecta o li falta algun d√≠git.');
      let blocs = [];
      for(let i = 0; i < cifratNums.length; i += blocWidth){
        let chunk = cifratNums.substr(i, blocWidth);
        blocs.push(parseInt(chunk, 10));
      }
      let d = parseInt(document.getElementById('input-d').value, 10);
      let n = parseInt(document.getElementById('input-n').value, 10);
      if (!blocs.length) return alert('El missatge xifrat no √©s v√†lid!');
      document.getElementById('spinner').style.display = '';
      document.getElementById('load-msg').textContent = t.loading;
      let start = performance.now();
      try {
        pyodide.runPython(`
clau_priv = (${d}, ${n})
xifrat_blocs = ${JSON.stringify(blocs)}
text_desxifrat = desxifrar_text(xifrat_blocs, clau_priv)
        `);
        let text_desxifrat = pyodide.globals.get('text_desxifrat');
        let end = performance.now();
        let ms = Math.round(end - start);
        let res = `<b>${t.decryptTitle.replace(/üîì /,"")}</b><br>${text_desxifrat || '[Buit o error de desxifrat]'}<br>
        <br><span class="small">${t.thanks}</span>`;
        document.getElementById('result-desxifrar').innerHTML = res;
        document.getElementById('result-desxifrar').style.display = '';
        document.getElementById('copy-desxifrat').style.display = '';
        document.getElementById('download-desxifrat').style.display = '';
        document.getElementById('copy-desxifrat').onclick = () => {
          let txt = `${t.decryptTitle}:\n${text_desxifrat || '[Buit o error de desxifrat]'}\n${t.thanks}\n${t.ms(ms)}`;
          navigator.clipboard.writeText(txt).then(() => {
            alert(t.copied);
          });
        };
        document.getElementById('download-desxifrat').onclick = function() {
          let txt = `${t.decryptTitle}:\n${text_desxifrat || '[Buit o error de desxifrat]'}\n${t.thanks}\n${t.ms(ms)}`;
          let blob = new Blob([txt], {type: 'text/plain'});
          let a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = 'xifrarecerca_desxifrat.txt';
          a.click();
        };
        document.getElementById('claus-ms-desxifrar').style.display = '';
        document.getElementById('claus-ms-desxifrar').innerHTML = t.ms(ms);
      } catch(err) {
        document.getElementById('result-desxifrar').innerHTML = 'Error en desxifrar! Revisa la clau privada i el missatge.<br>' + (err.message || err);
        document.getElementById('result-desxifrar').style.display = '';
        document.getElementById('copy-desxifrat').style.display = 'none';
        document.getElementById('download-desxifrat').style.display = 'none';
        document.getElementById('claus-ms-desxifrar').style.display = 'none';
      }
      document.getElementById('spinner').style.display = 'none';
    };

    // --------- Pantalla i validaci√≥ primes igual ---------
    function mostrarPantalla(quin) {
      document.getElementById('pantalla-inici').style.display = quin === 'inici' ? '' : 'none';
      document.getElementById('pantalla-xifrar').style.display = quin === 'xifrar' ? '' : 'none';
      document.getElementById('pantalla-desxifrar').style.display = quin === 'desxifrar' ? '' : 'none';
      document.getElementById('result-xifrar').style.display = 'none';
      document.getElementById('download-xifrar').style.display = 'none';
      document.getElementById('copy-result').style.display = 'none';
      document.getElementById('result-desxifrar').style.display = 'none';
      document.getElementById('copy-desxifrat').style.display = 'none';
      document.getElementById('download-desxifrat').style.display = 'none';
      document.getElementById('alert-xifrar').style.display = 'none';
      document.getElementById('claus-bits').style.display = 'none';
      document.getElementById('claus-bytes').style.display = 'none';
      document.getElementById('claus-ms').style.display = 'none';
      document.getElementById('claus-ms-desxifrar').style.display = 'none';
      document.getElementById('small-primes-warning').style.display = 'none';
      if (quin === 'xifrar') document.getElementById('form-xifrar').reset();
      if (quin === 'desxifrar') document.getElementById('form-desxifrar').reset();
    }
    function validatePrimes() {
      let p = parseInt(document.getElementById('input-p').value,10);
      let q = parseInt(document.getElementById('input-q').value,10);
      let alertMsg = '';
      let pHelp = '';
      let qHelp = '';
      let t = texts[currentLang];
      if (p && !esPrimer(p)) pHelp = t.notPrime('p');
      if (q && !esPrimer(q)) qHelp = t.notPrime('q');
      if (p && q && p===q) alertMsg = t.samePrime;
      if ((p && p>999999999999999999)||(q && q>999999999999999999)) alertMsg = t.tooBig;
      document.getElementById('p-help').innerHTML = pHelp;
      document.getElementById('q-help').innerHTML = qHelp;
      document.getElementById('alert-xifrar').innerHTML = alertMsg;
      document.getElementById('alert-xifrar').style.display = (alertMsg||pHelp||qHelp)?'':'none';
      // bits info nom√©s si vols mostrar-ho manualment
      document.getElementById('claus-bits').innerHTML = '';
      document.getElementById('claus-bits').style.display = 'none';
    }
    document.getElementById('input-p').addEventListener('blur', validatePrimes);
    document.getElementById('input-q').addEventListener('blur', validatePrimes);
    document.getElementById('input-p').addEventListener('input', validatePrimes);
    document.getElementById('input-q').addEventListener('input', validatePrimes);
    document.querySelectorAll('.back').forEach(el=>{
      el.addEventListener('keypress',function(ev){
        if (ev.key==='Enter' || ev.key===' ') { mostrarPantalla('inici'); }
      });
    });
    mostrarPantalla('inici');
  </script>
</body>
</html>
